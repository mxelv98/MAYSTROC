<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAYSTRO CRASH</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600&family=Inter:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the professional theme */
        body {
            font-family: 'Inter', 'Cairo', sans-serif;
            background: #000000; /* Solid black background */
            color: #E0E0E0; /* Light grey for general text */
            overflow: hidden; /* Prevent scrolling during splash screen */
        }

        /* General button style */
        .button-base {
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.125rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.05em;
            white-space: nowrap;
            height: 56px; /* Fixed height for buttons */
        }

        /* Default action button (Update Result) and AI buttons */
        .action-button-gradient {
            background-image: linear-gradient(to right, #7acd07, #9ffd09);
            color: #1A1A1A;
            box-shadow: 0 6px 20px rgba(159, 253, 9, 0.4);
            border: 1px solid rgba(159, 253, 9, 0.3);
        }
        .action-button-gradient:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(159, 253, 9, 0.6);
            transform: translateY(-3px);
        }
        .action-button-gradient:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(159, 253, 9, 0.3);
            transform: scale(0.98);
        }

        /* Disabled button style for cooldown */
        .cooldown-button, .action-button-gradient:disabled {
            background-image: linear-gradient(to right, #2A2A2A, #3A3A3A);
            color: #888888;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
            opacity: 0.7;
            border: 1px solid #4A4A4A;
        }
        .cooldown-button:hover, .action-button-gradient:disabled:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Box styling */
        .box-container {
            background-color: #1E1E1E;
            padding: 2.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Main title animation */
        .title-pulse {
            animation: pulse-glow-new 2s infinite ease-in-out;
        }
        @keyframes pulse-glow-new {
            0%, 100% { text-shadow: 0 0 10px rgba(159, 253, 9, 0.7); }
            50% { text-shadow: 0 0 20px rgba(159, 253, 9, 1); }
        }

        /* Loading spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #9ffd09;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .loading-spinner.light {
             border-top-color: #1A1A1A;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Splash screen logo animation */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite ease-in-out;
        }

        /* Main content entrance animation */
        @keyframes fade-slide-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-slide-in-active {
            animation: fade-slide-in 0.8s ease-out forwards;
        }

        /* Result labels update animation */
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .label-update-animation {
            animation: pop-in 0.4s ease-out;
        }

        /* Icon change animation */
        @keyframes icon-fade-in {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .icon-animation {
            animation: icon-fade-in 0.5s ease-out;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal-content {
            background-color: #1E1E1E;
            padding: 2.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 0 40px rgba(159, 253, 9, 0.4);
            text-align: center;
            max-width: 90%;
            width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-overlay.show .modal-content { transform: translateY(0); }
        
        .main-title-logo {
            width: 5rem; height: 5rem;
            display: inline-block;
            vertical-align: middle;
            margin-left: 1rem;
        }
        .input-field {
            background-color: #0A0A0A;
            border: 1px solid #4A4A4A;
            color: #E0E0E0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            margin-top: 0.5rem;
            font-size: 1rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #9ffd09;
            box-shadow: 0 0 0 3px rgba(159, 253, 9, 0.3);
        }
        /* Style for the game score font */
        .game-score-font {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.8rem;
            line-height: 1.2;
        }
        .telegram-logo-link {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            flex-direction: column;
            gap: 0.5rem;
        }
        .telegram-logo {
            width: 60px; height: 60px;
            transition: transform 0.2s ease-in-out;
        }
        .telegram-logo:hover {
            transform: scale(1.1);
        }
        /* Responsive font sizes */
        @media (max-width: 768px) {
            .game-score-font { font-size: 1.3rem; }
        }
        @media (max-width: 480px) {
            .game-score-font { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-[#000000] z-50 transition-opacity duration-700 opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 144" class="w-36 h-36 rounded-full mb-6 animate-bounce-slow">
            <rect width="144" height="144" rx="72" fill="#1E1E1E"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="'Press Start 2P', cursive" font-size="60" fill="#9ffd09">MC</text>
        </svg>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-[#9ffd09] mb-4">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ MAYSTRO CRASH ğŸ‘‹</h3>
            <p class="text-lg text-gray-300 mb-6">
                Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ù„Ù„Ø¨Ø¯Ø¡.
            </p>
            <div class="flex flex-col space-y-4">
                 <button onclick="showLoginModal()" class="button-base action-button-gradient px-8 py-3 rounded-xl text-black font-semibold text-lg">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
                <button onclick="showSignupModal()" class="button-base cooldown-button px-8 py-3 rounded-xl font-semibold text-lg">
                    ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-[#9ffd09] mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4 text-right">
                    <label for="loginEmailInput" class="block text-gray-300 text-lg mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="loginEmailInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ..." class="input-field text-right" required>
                </div>
                <div class="mb-6 text-right">
                    <label for="loginPasswordInput" class="block text-gray-300 text-lg mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="loginPasswordInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±..." class="input-field text-right" required>
                </div>
                 <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button type="submit" class="button-base action-button-gradient w-full py-3 rounded-xl text-black font-semibold text-lg">
                    Ø¯Ø®ÙˆÙ„
                </button>
            </form>
             <button onclick="hideCurrentModalAndShowWelcome()" class="text-gray-400 hover:text-white mt-4">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signup-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-[#9ffd09] mb-4">ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <form id="signup-form" onsubmit="handleSignup(event)">
                <p class="text-sm text-gray-400 mb-4 text-center">
                    Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠ <span class="text-[#9ffd09] font-bold">MAS98</span> Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ²Ø§Øª.
                </p>
                <div class="grid grid-cols-2 gap-4 mb-4 text-right">
                    <div>
                        <label for="signupFirstNameInput" class="block text-gray-300 text-lg mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„:</label>
                        <input type="text" id="signupFirstNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯" class="input-field text-right" required>
                    </div>
                    <div>
                        <label for="signupLastNameInput" class="block text-gray-300 text-lg mb-2">Ø§Ù„Ù„Ù‚Ø¨:</label>
                        <input type="text" id="signupLastNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ" class="input-field text-right" required>
                    </div>
                </div>
                 <div class="mb-4 text-right">
                    <label for="signupDobInput" class="block text-gray-300 text-lg mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                    <input type="date" id="signupDobInput" class="input-field text-right" required>
                </div>
                 <div class="mb-4 text-right">
                    <label for="signupEmailInput" class="block text-gray-300 text-lg mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="signupEmailInput" placeholder="you@example.com" class="input-field text-right" required>
                </div>
                <div class="mb-6 text-right">
                    <label for="signupPasswordInput" class="block text-gray-300 text-lg mb-2">Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="signupPasswordInput" placeholder="********" class="input-field text-right" required>
                </div>
                <p id="signup-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button type="submit" class="button-base action-button-gradient w-full py-3 rounded-xl text-black font-semibold text-lg">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                </button>
            </form>
             <button onclick="hideCurrentModalAndShowWelcome()" class="text-gray-400 hover:text-white mt-4">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="verification-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="verification-title" class="text-2xl font-bold text-[#9ffd09] mb-4"></h3>
            <p id="verification-message" class="text-lg text-gray-300 mb-6"></p>
            <div id="verification-actions" class="flex flex-col space-y-4">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>


    <!-- Main Content Container (initially hidden) -->
    <div id="main-content" class="hidden flex-col items-center justify-center min-h-screen p-6 text-white text-right">
        
        <div class="w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto flex justify-between items-center mb-4">
            <div id="userIdDisplay" class="text-xl text-gray-400"></div>
            <button onclick="handleSignOut()" class="text-gray-400 hover:text-[#9ffd09] text-sm font-bold">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>

        <!-- Main Title -->
        <h2 class="text-4xl md:text-5xl font-extrabold text-[#9ffd09] mb-8 title-pulse">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 144" class="main-title-logo">
                <rect width="144" height="144" rx="72" fill="#1E1E1E"/>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="'Press Start 2P', cursive" font-size="60" fill="#9ffd09">MC</text>
            </svg>
            <span class="game-score-font">MAYSTRO CRASH</span>
        </h2>

        <!-- Simulator Box -->
        <div class="box-container w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto">
            <div id="resultOutput" class="label text-4xl font-bold mt-4 mb-2 text-white transition-all duration-300 ease-in-out">---</div>
            <div id="percentageDisplay" class="label text-2xl text-gray-400 mb-4 transition-all duration-300 ease-in-out">---</div>
            <div id="result-icon-container" class="text-7xl my-6 mx-auto flex items-center justify-center h-24">
                <span id="result-icon" class="icon-animation" style="display: none;"></span>
            </div>
            <div id="potentialOutcome" class="label text-xl text-gray-400 mt-4 transition-all duration-300 ease-in-out">---</div>
            <div id="protectionValue" class="label text-xl text-gray-400 mt-2 transition-all duration-300 ease-in-out">---</div>
        </div>

        <!-- Control Buttons -->
        <div class="controls mt-8 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="updateResultButton" onclick="updateResults()" class="button-base action-button-gradient">
                <span id="updateResultButtonText">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©</span>
            </button>
            <button id="analyzeButton" onclick="showVipMessage('analysis')" class="button-base cooldown-button">
                <span>âœ¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© (VIP)</span>
                <div class="loading-spinner ml-2 hidden"></div>
            </button>
            <button id="strategyTipsButton" onclick="showVipMessage('strategy')" class="button-base cooldown-button">
                <span>âœ¨ Ù†ØµØ§Ø¦Ø­ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (VIP)</span>
                <div class="loading-spinner ml-2 hidden"></div>
            </button>
            <button id="futurePredictionButton" onclick="showVipMessage('future')" class="button-base cooldown-button">
                <span>ğŸ”® ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (VIP)</span>
                <div class="loading-spinner ml-2 hidden"></div>
            </button>
        </div>
        
        <!-- Gemini API Outputs and Static Diagnostics... -->
        <div id="geminiAnalysis" class="box-container mt-8 w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right" style="min-height: 100px;">
            <h3 class="text-xl font-bold text-[#9ffd09] mb-4">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:</h3>
            <p id="analysisOutput" class="text-gray-300 text-lg">
                Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© (VIP)" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.
            </p>
        </div>
        <div id="geminiStrategyTips" class="box-container mt-8 w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right" style="min-height: 100px;">
            <h3 class="text-xl font-bold text-[#9ffd09] mb-4">Ù†ØµØ§Ø¦Ø­ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</h3>
            <p id="strategyTipsOutput" class="text-gray-300 text-lg">
                Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ù†ØµØ§Ø¦Ø­ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (VIP)" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµØ§Ø¦Ø­ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.
            </p>
        </div>
        <div id="geminiFuturePrediction" class="box-container mt-8 w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right" style="min-height: 100px;">
            <h3 class="text-xl font-bold text-[#9ffd09] mb-4">ğŸ”® ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h3>
            <p id="futurePredictionOutput" class="text-gray-300 text-lg">
                Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (VIP)" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙ‚Ø¹Ø§Øª Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.
            </p>
        </div>
        <div id="staticDiagnostic" class="box-container mt-8 w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right">
            <h3 class="text-xl font-bold text-[#9ffd09] mb-4">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ:</h3>
            <ul class="text-gray-300 text-lg list-disc pr-6">
                <li class="mb-2">Ù…ØªÙˆØ³Ø· Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©: 1.85x</li>
                <li class="mb-2">Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø± Ù‚Ø¨Ù„ 2x: Ø­ÙˆØ§Ù„ÙŠ 60%</li>
                <li class="mb-2">Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ 5x Ø£Ùˆ Ø£ÙƒØ«Ø±: Ø­ÙˆØ§Ù„ÙŠ 25%</li>
                <li class="mb-2">Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù†Ù‡ÙŠØ§Ø± Ù…Ø³Ø¬Ù„Ø©: 15.78x</li>
                <li>Ø£Ø¯Ù†Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù†Ù‡ÙŠØ§Ø± Ù…Ø³Ø¬Ù„Ø©: 1.01x</li>
            </ul>
            <div class="telegram-logo-link">
                <a href="https://t.me/maysttrobet" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="telegram-logo" fill="#9ffd09">
                        <path d="M22,3.23a1,1,0,0,0-.9-.72,1,1,0,0,0-.49.12L3,11.38A1,1,0,0,0,3,13.26l4.47,1.86a.5.5,0,0,0,.47-.13L15,8.19c.2-.17.41,0,.23.19l-6,5.31a.51.51,0,0,0-.14.47L9.89,19a1,1,0,0,0,1,.86,1,1,0,0,0,.75-.34l2.42-2.83,3.3,1.38A1,1,0,0,0,19,18.1a1,1,0,0,0,.48-.13L21.9,4.4A1,1,0,0,0,22,3.23Z"></path>
                    </svg>
                </a>
                <span class="text-gray-400 text-sm mt-2">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</span>
            </div>
        </div>

    </div> <!-- End of main-content -->

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            setPersistence,
            browserSessionPersistence,
            sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, auth, db;

        // --- UI Control & State ---
        let splashHidden = false;
        let currentModal = null;
        let authInitialized = false;

        function hideSplashScreen() {
            if (splashHidden) return;
            const splashScreen = document.getElementById('splash-screen');
            splashScreen.style.opacity = '0';
            setTimeout(() => splashScreen.classList.add('hidden'), 700);
            splashHidden = true;
        }
        
        function showModal(modalId) {
            if (currentModal) hideModal(currentModal);
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            currentModal = modalId;
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => modal.classList.add('hidden'), 300);
            if (currentModal === modalId) currentModal = null;
        }

        function showWelcomeModal() {
            hideAllModals();
            showModal('welcome-modal');
        }

        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                if(modal.id) hideModal(modal.id);
            });
        }
        
        window.showLoginModal = () => showModal('login-modal');
        window.showSignupModal = () => showModal('signup-modal');
        window.hideCurrentModalAndShowWelcome = () => {
            if (currentModal) hideModal(currentModal);
            showWelcomeModal();
        };

        function setButtonLoading(formId, isLoading) {
            const button = document.querySelector(`#${formId} button[type="submit"]`);
            if (!button) return;

            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<div class="loading-spinner light mx-auto"></div>`;
            } else {
                button.disabled = false;
                button.innerHTML = (formId === 'login-form') ? 'Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
            }
        }

        // --- Firebase Initialization and Auth Flow ---
        try {
            const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(firebaseConfigStr);
            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase config is missing or invalid.");
            }
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            const authTimeout = setTimeout(() => {
                if (!authInitialized) {
                    console.warn("Auth state did not resolve in time. Forcing UI.");
                    hideSplashScreen();
                    showWelcomeModal();
                }
            }, 7000);

            setPersistence(auth, browserSessionPersistence)
                .then(() => {
                    return onAuthStateChanged(auth, async (user) => {
                        authInitialized = true;
                        clearTimeout(authTimeout);
                        hideSplashScreen();

                        if (user && user.emailVerified) {
                            await showMainApp(user);
                        } else {
                            if (user) await signOut(auth); 
                            showWelcomeModal();
                        }
                    });
                })
                .catch((error) => {
                    authInitialized = true;
                    clearTimeout(authTimeout);
                    console.error("Error setting persistence:", error);
                    hideSplashScreen();
                    showWelcomeModal();
                });

        } catch (error) {
            console.error("FATAL: Firebase initialization failed.", error);
            hideSplashScreen();
            document.body.innerHTML = `<div class="flex items-center justify-center h-screen text-center bg-black"><div><h1 class="text-2xl font-bold text-red-500">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</h1><p class="text-lg text-gray-300 mt-2">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù….</p></div></div>`;
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- LOGIN/SIGNUP HANDLERS ---
        window.handleLogin = async function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmailInput').value;
            const password = document.getElementById('loginPasswordInput').value;
            const errorElement = document.getElementById('login-error');
            errorElement.innerText = '';
            setButtonLoading('login-form', true);

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                if (!user.emailVerified) {
                    await signOut(auth);
                    showVerificationModal(user, 'login-unverified');
                }
                // onAuthStateChanged handles successful, verified login
            } catch (error) {
                console.error("Login Error:", error.code);
                let message = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                }
                errorElement.innerText = message;
            } finally {
                setButtonLoading('login-form', false);
            }
        }

        window.handleSignup = async function(event) {
            event.preventDefault();
            const firstName = document.getElementById('signupFirstNameInput').value;
            const lastName = document.getElementById('signupLastNameInput').value;
            const dob = document.getElementById('signupDobInput').value;
            const email = document.getElementById('signupEmailInput').value;
            const password = document.getElementById('signupPasswordInput').value;
            const errorElement = document.getElementById('signup-error');
            errorElement.innerText = '';
            setButtonLoading('signup-form', true);
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await sendEmailVerification(user);

                const userDocRef = doc(db, "artifacts", appId, "users", user.uid);
                await setDoc(userDocRef, {
                    firstName, lastName, dob,
                    email: user.email,
                    createdAt: new Date()
                });
                
                await signOut(auth);
                showVerificationModal(null, 'signup-success');

            } catch (error) {
                console.error("Signup Error:", error.code);
                if (error.code === 'auth/email-already-in-use') {
                    errorElement.innerText = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.";
                } else if (error.code === 'auth/weak-password') {
                     errorElement.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
                } else {
                    errorElement.innerText = "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                }
            } finally {
                setButtonLoading('signup-form', false);
            }
        }

        function showVerificationModal(user, context) {
            const titleEl = document.getElementById('verification-title');
            const messageEl = document.getElementById('verification-message');
            const actionsEl = document.getElementById('verification-actions');
            actionsEl.innerHTML = '';

            if (context === 'signup-success') {
                titleEl.innerText = 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!';
                messageEl.innerText = 'Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø§Ø¨Ø· ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø«Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                const closeBtn = document.createElement('button');
                closeBtn.className = 'button-base action-button-gradient w-full py-3';
                closeBtn.innerText = 'ÙÙ‡Ù…Øª';
                closeBtn.onclick = hideCurrentModalAndShowWelcome;
                actionsEl.appendChild(closeBtn);
            } else if (context === 'login-unverified') {
                titleEl.innerText = 'âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„';
                messageEl.innerText = 'ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ØŸ';
                const resendBtn = document.createElement('button');
                resendBtn.className = 'button-base action-button-gradient w-full py-3';
                resendBtn.innerText = 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·';
                resendBtn.onclick = async () => {
                    try {
                        await sendEmailVerification(user);
                        messageEl.innerText = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.';
                        resendBtn.disabled = true;
                        resendBtn.innerHTML = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
                    } catch (err) {
                        messageEl.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.';
                    }
                };
                actionsEl.appendChild(resendBtn);
                const closeBtn = document.createElement('button');
                closeBtn.className = 'text-gray-400 hover:text-white mt-4';
                closeBtn.innerText = 'Ø¥ØºÙ„Ø§Ù‚';
                closeBtn.onclick = hideCurrentModalAndShowWelcome;
                actionsEl.appendChild(closeBtn);
            }
            showModal('verification-modal');
        }
        
        // --- MAIN APP LOGIC ---
        window.handleSignOut = async function() {
            try {
                await signOut(auth);
                document.getElementById('main-content').classList.add('hidden');
                showWelcomeModal();
            } catch (error) {
                console.error("Sign Out Error", error);
            }
        };

        async function showMainApp(user) {
            hideAllModals();
            const mainContent = document.getElementById('main-content');
            const userIdDisplay = document.getElementById('userIdDisplay');

            try {
                const userDocRef = doc(db, "artifacts", appId, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    userIdDisplay.innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${docSnap.data().firstName}`;
                } else {
                     userIdDisplay.innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ`;
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                userIdDisplay.innerText = `ID: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„`;
            }

            mainContent.classList.remove('hidden');
            mainContent.classList.add('flex', 'fade-slide-in-active');
            document.body.style.overflow = 'auto';

            document.getElementById("resultOutput").innerText = "---";
            document.getElementById("percentageDisplay").innerText = "---";
            document.getElementById("result-icon").style.display = 'none';
            document.getElementById("potentialOutcome").innerText = "---";
            document.getElementById("protectionValue").innerText = "---";

            updateRefreshButtonState();
        }

        // --- GAME LOGIC & HELPERS ---
        let currentResultCategory = "---";
        let lastRefreshTime = 0;
        let refreshCooldownTimerId = null;
        const DEFAULT_COOLDOWN = 120;

        function getRandom(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        
        window.updateResults = function() {
            const now = Date.now();
            if ((now - lastRefreshTime) / 1000 < DEFAULT_COOLDOWN) return;

            const resultOutcome = Math.random() < 0.5 ? "Positive" : "Other";
            currentResultCategory = resultOutcome;

            const els = {
                output: document.getElementById("resultOutput"),
                percent: document.getElementById("percentageDisplay"),
                icon: document.getElementById("result-icon"),
                potential: document.getElementById("potentialOutcome"),
                protection: document.getElementById("protectionValue")
            };

            els.icon.style.display = 'block';

            if (resultOutcome === "Positive") {
                els.potential.innerText = "ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ 5X";
                els.protection.innerText = `${getRandom(2, 2)}.${getRandom(1, 59)}X`;
                els.output.innerText = `${getRandom(2, 4)}.${getRandom(1, 59)}X`;
                els.percent.innerText = `${getRandom(50, 70)}%`;
                els.icon.innerText = "âœ…";
            } else {
                els.potential.innerText = "Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±";
                els.protection.innerText = `${getRandom(0, 1)}.${getRandom(1, 30)}X`;
                els.output.innerText = `${getRandom(1, 1)}.${getRandom(1, 59)}X`;
                els.percent.innerText = `${getRandom(40, 50)}%`;
                els.icon.innerText = "âš ï¸";

                if (Math.random() < 0.5) { els.potential.innerText = "Ø§Ù„Ø®Ø·Ø± 4X"; els.icon.innerText = "ğŸš¨"; }
                if (Math.random() < 0.3) { els.potential.innerText = "Ø§Ø³ØªÙ‚Ø±Ø§Ø± 6X"; els.icon.innerText = "ğŸ“ˆ"; }
            }

            Object.values(els).forEach(el => {
                el.classList.remove('label-update-animation');
                void el.offsetWidth;
                el.classList.add('label-update-animation');
            });
            lastRefreshTime = now;
            updateRefreshButtonState();
        }

        function updateRefreshButtonState() {
            const updateButton = document.getElementById("updateResultButton");
            const textSpan = document.getElementById("updateResultButtonText");
            const timeRemaining = Math.max(0, DEFAULT_COOLDOWN - Math.floor((Date.now() - lastRefreshTime) / 1000));

            if (timeRemaining > 0) {
                updateButton.disabled = true;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                textSpan.innerText = `Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (!refreshCooldownTimerId) {
                    refreshCooldownTimerId = setInterval(updateRefreshButtonState, 1000);
                }
            } else {
                updateButton.disabled = false;
                textSpan.innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©";
                clearInterval(refreshCooldownTimerId);
                refreshCooldownTimerId = null;
            }
        }
        
        window.showVipMessage = function(type) {
            const outputIds = {
                analysis: "analysisOutput",
                strategy: "strategyTipsOutput",
                future: "futurePredictionOutput"
            };
            document.getElementById(outputIds[type]).innerText = `Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ VIP!`;
        }
    </script>
</body>
</html>

