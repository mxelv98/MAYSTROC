<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAYSTRO CRASH</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for gradients and shadows not easily done with pure Tailwind */
        body {
            font-family: 'Inter', 'Cairo', sans-serif; /* Prefer Inter, fallback to Cairo */
            background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
            overflow: hidden; /* Prevent scrolling during splash screen */
        }
        .button-gradient {
            background-image: linear-gradient(to right, #ffcc00, #ffdb58);
            box-shadow: 0 4px 15px rgba(255, 204, 0, 0.4);
            transition: all 0.3s ease;
        }
        .button-gradient:hover {
            box-shadow: 0 6px 20px rgba(255, 204, 0, 0.6);
            transform: translateY(-2px);
        }
        .button-gradient:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 204, 0, 0.3);
            transform: scale(0.98); /* Added subtle scale on click */
        }
        .box-shadow {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffcc00;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom animation for splash screen logo */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite ease-in-out;
        }

        /* Animation for main content entrance */
        @keyframes fade-slide-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-slide-in-active {
            animation: fade-slide-in 0.8s ease-out forwards;
        }

        /* Animation for result labels update */
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .label-update-animation {
            animation: pop-in 0.4s ease-out;
        }

        /* Animation for icon change */
        @keyframes icon-fade-in {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .icon-animation {
            animation: icon-fade-in 0.5s ease-out;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-[#0f0f0f] z-50 transition-opacity duration-700 opacity-100">
        <!-- Using the provided image for the logo -->
        <img src="images/logo.png" alt="App Logo" class="w-36 h-36 rounded-full mb-6 animate-bounce-slow">
        <h1 class="text-4xl font-bold text-[#ffcc00]">MAYSTRO CRASH</h1>
        <p class="text-xl text-gray-300 mt-2">جاري التحميل...</p>
    </div>

    <!-- Main Content Container (initially hidden) -->
    <div id="main-content" class="hidden flex-col items-center justify-center min-h-screen p-6 text-white text-right">

        <!-- Main Title -->
        <h2 class="text-4xl md:text-5xl font-extrabold text-[#ffcc00] mb-8 animate-pulse">
            🎯 MAYSTRO CRASH
        </h2>

        <!-- Simulator Box -->
        <div class="box bg-[#202020] p-8 rounded-2xl inline-block mt-8 box-shadow
                    w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto">
            <!-- Output Labels -->
            <div id="saida" class="label text-3xl font-bold mt-4 mb-2 transition-all duration-300 ease-in-out">---</div>
            <div id="grafico" class="label text-2xl text-gray-300 mb-4 transition-all duration-300 ease-in-out">---</div>

            <!-- Dynamic Result Icon -->
            <div id="result-icon-container" class="text-6xl my-6 mx-auto flex items-center justify-center h-20">
                <span id="result-icon" class="icon-animation"></span>
            </div>

            <div id="posivel" class="label text-xl text-gray-400 mt-4 transition-all duration-300 ease-in-out">---</div>
            <div id="protecao" class="label text-xl text-gray-400 mt-2 transition-all duration-300 ease-in-out">---</div>

            <!-- Removed Countdown Timer -->
            <!-- <div id="countdown" class="text-base mt-4 text-gray-500">التحديث القادم خلال: 12 ثانية</div> -->
        </div>

        <!-- Control Buttons -->
        <div class="controls mt-8 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <!-- New button to manually update results -->
            <button onclick="atualizarResultados()"
                    class="button-gradient px-8 py-3 rounded-xl text-black font-semibold text-lg
                           hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#ffcc00] focus:ring-opacity-50">
                تحديث النتيجة
            </button>
            <!-- Removed Start and Stop buttons -->
            <!-- <button onclick="startUpdates()"
                    class="button-gradient px-8 py-3 rounded-xl text-black font-semibold text-lg
                           hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#ffcc00] focus:ring-opacity-50">
                ابدأ
            </button>
            <button onclick="stopUpdates()"
                    class="button-gradient px-8 py-3 rounded-xl text-black font-semibold text-lg
                           hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#ffcc00] focus:ring-opacity-50">
                أوقف
            </button> -->
            <button id="analyzeButton" onclick="analyzeResultWithGemini()"
                    class="button-gradient px-8 py-3 rounded-xl text-black font-semibold text-lg
                           hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#ffcc00] focus:ring-opacity-50
                           flex items-center justify-center">
                <span id="analyzeButtonText">✨ تحليل النتيجة</span>
                <div id="analyzeLoadingSpinner" class="loading-spinner ml-2 hidden"></div>
            </button>
            <button id="strategyTipsButton" onclick="getStrategyTipsWithGemini()"
                    class="button-gradient px-8 py-3 rounded-xl text-black font-semibold text-lg
                           hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#ffcc00] focus:ring-opacity-50
                           flex items-center justify-center">
                <span id="strategyTipsButtonText">✨ نصائح استراتيجية</span>
                <div id="strategyTipsLoadingSpinner" class="loading-spinner ml-2 hidden"></div>
            </button>
        </div>

        <!-- Gemini API Analysis Output -->
        <div id="geminiAnalysis" class="bg-[#202020] p-6 rounded-2xl mt-8 box-shadow
                                         w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right"
             style="min-height: 100px;">
            <h3 class="text-xl font-bold text-[#ffcc00] mb-4">تحليل الذكاء الاصطناعي:</h3>
            <p id="analysisOutput" class="text-gray-300 text-lg">
                انقر على "تحليل النتيجة" للحصول على تحليل من الذكاء الاصطناعي.
            </p>
        </div>

        <!-- Gemini API Strategy Tips Output -->
        <div id="geminiStrategyTips" class="bg-[#202020] p-6 rounded-2xl mt-8 box-shadow
                                            w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right"
             style="min-height: 100px;">
            <h3 class="text-xl font-bold text-[#ffcc00] mb-4">نصائح استراتيجية:</h3>
            <p id="strategyTipsOutput" class="text-gray-300 text-lg">
                انقر على "نصائح استراتيجية" للحصول على نصائح من الذكاء الاصطناعي.
            </p>
        </div>

        <!-- Static Diagnostic/Statistical Section -->
        <div id="staticDiagnostic" class="bg-[#202020] p-6 rounded-2xl mt-8 box-shadow
                                            w-full max-w-sm md:max-w-md lg:max-w-lg mx-auto text-right">
            <h3 class="text-xl font-bold text-[#ffcc00] mb-4">📊 التحليل الإحصائي:</h3>
            <ul class="text-gray-300 text-lg list-disc pr-6">
                <li class="mb-2">متوسط نقطة الانهيار التاريخية: 1.85x</li>
                <li class="mb-2">احتمالية الانهيار قبل 2x: حوالي 60%</li>
                <li class="mb-2">احتمالية الوصول إلى 5x أو أكثر: حوالي 25%</li>
                <li class="mb-2">أعلى نقطة انهيار مسجلة: 15.78x</li>
                <li>أدنى نقطة انهيار مسجلة: 1.01x</li>
            </ul>
            <p class="text-gray-400 text-sm mt-4">
                هذه الإحصائيات تقديرية وقد تختلف في اللعب الفعلي.
            </p>
        </div>

    </div> <!-- End of main-content -->

    <script>
        // Global variables for interval ID and countdown timer
        // let intervalId; // No longer needed for automatic updates
        // let countdown = 12; // No longer needed for automatic updates
        let currentResultCategory = "---"; // To store "Rosa" or "Outro" for Gemini analysis

        /**
         * Generates a random integer between min (inclusive) and max (inclusive).
         * @param {number} min - The minimum value.
         * @param {number} max - The maximum value.
         * @returns {number} A random integer.
         */
        function getRandom(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Applies and removes a CSS animation class to an element to trigger a re-animation.
         * @param {HTMLElement} element - The DOM element to animate.
         * @param {string} animationClass - The CSS class containing the animation.
         */
        function triggerAnimation(element, animationClass) {
            element.classList.remove(animationClass);
            // Force reflow to restart animation
            void element.offsetWidth; // This line forces a reflow
            element.classList.add(animationClass);
        }

        /**
         * Updates the simulator results based on a random outcome.
         * The logic simulates different "Pronto" scenarios.
         */
        function atualizarResultados() {
            // Determine the main outcome: "Rosa" (Pink) or "Outro" (Other)
            let Resultado = Math.random() < 0.5 ? "Rosa" : "Outro";
            currentResultCategory = Resultado; // Store the current result category

            // Get references to DOM elements
            const saida = document.getElementById("saida");
            const grafico = document.getElementById("grafico");
            const resultIcon = document.getElementById("result-icon");
            const posivel = document.getElementById("posivel");
            const protecao = document.getElementById("protecao");

            // Logic to update content and icons
            if (Resultado === "Rosa") {
                posivel.innerText = "تقريباً 5X";
                protecao.innerText = getRandom(2, 2) + "." + getRandom(1, 59) + "X";
                saida.innerText = getRandom(2, 4) + "." + getRandom(1, 59) + "X";
                grafico.innerText = getRandom(50, 70) + "%";
                resultIcon.innerText = "✅"; // Good outcome icon
            } else {
                posivel.innerText = "الدخول لمنطقة الخطر";
                protecao.innerText = getRandom(0, 1) + "." + getRandom(1, 30) + "X";
                saida.innerText = getRandom(1, 1) + "." + getRandom(1, 59) + "X";
                grafico.innerText = getRandom(40, 50) + "%";
                resultIcon.innerText = "⚠️"; // Warning/Danger outcome icon

                if (Math.random() < 0.5) {
                    posivel.innerText = "الخطر 4X";
                    protecao.innerText = getRandom(2, 2) + "." + getRandom(1, 59) + "X";
                    saida.innerText = getRandom(2, 4) + "." + getRandom(1, 59) + "X";
                    grafico.innerText = getRandom(50, 70) + "%";
                    resultIcon.innerText = "🚨"; // More specific danger icon
                }

                if (Math.random() < 0.3) {
                    posivel.innerText = "استقرار 6X";
                    protecao.innerText = getRandom(2, 2) + "." + getRandom(1, 59) + "X";
                    saida.innerText = getRandom(2, 4) + "." + getRandom(1, 59) + "X";
                    grafico.innerText = getRandom(50, 70) + "%";
                    resultIcon.innerText = "📈"; // Stability/Growth icon
                }
            }

            // Trigger pop-in animation for each updated label
            triggerAnimation(saida, 'label-update-animation');
            triggerAnimation(grafico, 'label-update-animation');
            triggerAnimation(posivel, 'label-update-animation');
            triggerAnimation(protecao, 'label-update-animation');
            triggerAnimation(resultIcon, 'icon-animation'); // Trigger animation for the icon
        }

        // Removed updateCountdown function as it's no longer needed
        /*
        function updateCountdown() {
            countdown--;
            document.getElementById("countdown").innerText =
                "التحديث القادم خلال: " + countdown + " ثانية";
            if (countdown <= 0) {
                atualizarResultados(); // Update results when countdown finishes
                countdown = 12; // Reset countdown
            }
        }
        */

        // Removed startUpdates and stopUpdates functions as they are no longer needed
        /*
        function startUpdates() {
            if (intervalId) return;
            atualizarResultados();
            countdown = 12;
            intervalId = setInterval(updateCountdown, 1000);
        }

        function stopUpdates() {
            clearInterval(intervalId);
            intervalId = null;
            document.getElementById("countdown").innerText = "متوقف حالياً";
        }
        */

        /**
         * Calls the Gemini API to analyze the current simulator results.
         */
        async function analyzeResultWithGemini() {
            const analyzeButton = document.getElementById("analyzeButton");
            const analyzeButtonText = document.getElementById("analyzeButtonText");
            const analyzeLoadingSpinner = document.getElementById("analyzeLoadingSpinner");
            const analysisOutput = document.getElementById("analysisOutput");

            // Disable button and show loading spinner
            analyzeButton.disabled = true;
            analyzeButtonText.classList.add("hidden");
            analyzeLoadingSpinner.classList.remove("hidden");
            analysisOutput.innerText = "جاري تحليل النتيجة بواسطة الذكاء الاصطناعي..."; // Loading message

            // Collect current simulator data
            const saidaValue = document.getElementById("saida").innerText;
            const graficoValue = document.getElementById("grafico").innerText;
            const posivelValue = document.getElementById("posivel").innerText;
            const protecaoValue = document.getElementById("protecao").innerText;

            const prompt = `
                حلل نتائج محاكاة "MAYSTRO CRASH" التالية وقدم شرحًا موجزًا ومفيدًا.
                الناتج الحالي (Saida): ${saidaValue}
                النسبة المئوية للرسم البياني (Grafico): ${graficoValue}
                النتيجة المحتملة (Posivel): ${posivelValue}
                الحماية (Protecao): ${protecaoValue}
                فئة النتيجة الرئيسية: ${currentResultCategory === "Rosa" ? "وردي (إيجابي)" : "آخر (قد يكون خطيرًا)"}

                ركز على تفسير هذه القيم للمستخدم بطريقة سهلة الفهم. اجعل الشرح موجزًا وفي حدود 100 كلمة وباللغة العربية الفصحى.
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave this as-is. Canvas will provide the API key.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    analysisOutput.innerText = text; // Display the LLM's response
                } else {
                    analysisOutput.innerText = "عذرًا، لم يتمكن الذكاء الاصطناعي من تحليل النتيجة حاليًا. يرجى المحاولة مرة أخرى.";
                    console.error("Gemini API response structure unexpected:", result);
                }
            } catch (error) {
                analysisOutput.innerText = "حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
                console.error("Error calling Gemini API:", error);
            } finally {
                // Re-enable button and hide loading spinner
                analyzeButton.disabled = false;
                analyzeButtonText.classList.remove("hidden");
                analyzeLoadingSpinner.classList.add("hidden");
            }
        }

        /**
         * Calls the Gemini API to get strategy tips based on the current simulator results.
         */
        async function getStrategyTipsWithGemini() {
            const strategyTipsButton = document.getElementById("strategyTipsButton");
            const strategyTipsButtonText = document.getElementById("strategyTipsButtonText");
            const strategyTipsLoadingSpinner = document.getElementById("strategyTipsLoadingSpinner");
            const strategyTipsOutput = document.getElementById("strategyTipsOutput");

            // Disable button and show loading spinner
            strategyTipsButton.disabled = true;
            strategyTipsButtonText.classList.add("hidden");
            strategyTipsLoadingSpinner.classList.remove("hidden");
            strategyTipsOutput.innerText = "جاري الحصول على نصائح استراتيجية بواسطة الذكاء الاصطناعي..."; // Loading message

            // Collect current simulator data
            const saidaValue = document.getElementById("saida").innerText;
            const graficoValue = document.getElementById("grafico").innerText;
            const posivelValue = document.getElementById("posivel").innerText;
            const protecaoValue = document.getElementById("protecao").innerText;

            const prompt = `
                بناءً على نتائج محاكاة "MAYSTRO CRASH" التالية، قدم 3-5 نصائح استراتيجية موجزة ومفيدة للمستخدم.
                الناتج الحالي (Saida): ${saidaValue}
                النسبة المئوية للرسم البياني (Grafico): ${graficoValue}
                النتيجة المحتملة (Posivel): ${posivelValue}
                الحماية (Protecao): ${protecaoValue}
                فئة النتيجة الرئيسية: ${currentResultCategory === "Rosa" ? "وردي (إيجابي)" : "آخر (قد يكون خطيرًا)"}

                ركز على نصائح قابلة للتطبيق في سياق لعبة "Crash" (مثل متى يجب السحب، أو المخاطرة، أو الانتظار).
                اجعل النصائح في شكل قائمة نقطية وباللغة العربية الفصحى.
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave this as-is. Canvas will provide the API key.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    strategyTipsOutput.innerText = text; // Display the LLM's response
                } else {
                    strategyTipsOutput.innerText = "عذرًا، لم يتمكن الذكاء الاصطناعي من تقديم نصائح حاليًا. يرجى المحاولة مرة أخرى.";
                    console.error("Gemini API response structure unexpected:", result);
                }
            } catch (error) {
                strategyTipsOutput.innerText = "حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
                console.error("Error calling Gemini API:", error);
            } finally {
                // Re-enable button and hide loading spinner
                strategyTipsButton.disabled = false;
                strategyTipsButtonText.classList.remove("hidden");
                strategyTipsLoadingSpinner.classList.add("hidden");
            }
        }

        // Splash screen logic
        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            const mainContent = document.getElementById('main-content');

            // Hide main content initially
            mainContent.classList.add('hidden');

            setTimeout(() => {
                splashScreen.style.opacity = '0'; // Start fade out
                setTimeout(() => {
                    splashScreen.classList.add('hidden'); // Hide splash screen completely
                    mainContent.classList.remove('hidden'); // Show main content
                    mainContent.classList.add('flex'); // Ensure flex display is applied
                    mainContent.classList.add('fade-slide-in-active'); // Trigger main content entrance animation
                    document.body.style.overflow = 'auto'; // Re-enable scrolling

                    // Manually trigger the first result update when the main content loads
                    atualizarResultados();
                }, 700); // Duration of transition opacity for fade-out
            }, 3000); // 3 seconds delay for splash screen
        });
    </script>
</body>
</html>
